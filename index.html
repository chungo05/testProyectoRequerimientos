<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esquemas Técnicos BMS - ASIL D</title>
    <style>
        /* CONFIGURACIÓN BÁSICA Y VARIABLES (Monocromático) */
        :root {
            --bg-main: #0a0a0a;       /* Negro profundo */
            --bg-panel: #141414;      /* Gris muy oscuro */
            --border: #333333;        /* Borde sutil */
            --border-active: #ffffff; /* Borde activo blanco */
            --text-main: #ffffff;
            --text-secondary: #a0a0a0;
            --box-bg: #1f1f1f;        /* Gris medio para cajas */
            --box-hover: #2a2a2a;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            transition: all 0.2s ease-in-out;
        }

        body {
            margin: 0;
            background-color: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            padding: 20px 40px;
            border-bottom: 1px solid var(--border);
            background-color: var(--bg-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { font-weight: 300; font-size: 20px; letter-spacing: 1px; margin: 0; }
        .subtitle { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; }

        /* LAYOUT PRINCIPAL */
        .layout {
            display: flex;
            height: 100%;
        }

        /* BARRA LATERAL (NAVEGACIÓN) */
        nav {
            width: 200px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .nav-btn {
            background: transparent;
            border: none;
            border-left: 3px solid transparent;
            color: var(--text-secondary);
            padding: 20px;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-btn:hover { background-color: var(--box-bg); color: var(--text-main); }
        .nav-btn.active { 
            border-left-color: var(--text-main); 
            background-color: var(--box-bg); 
            color: var(--text-main); 
            font-weight: bold;
        }

        /* ÁREA DEL DIAGRAMA */
        .diagram-canvas {
            flex: 1;
            position: relative;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .diagram-wrapper {
            display: none;
            width: 100%;
            max-width: 800px;
            animation: fadeUp 0.4s ease;
        }
        
        .diagram-wrapper.active { display: block; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* PANEL DE INFORMACIÓN */
        aside {
            width: 300px;
            background-color: var(--bg-panel);
            border-left: 1px solid var(--border);
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-title { font-size: 18px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin: 0; }
        .info-desc { font-size: 14px; line-height: 1.6; color: var(--text-secondary); }
        .info-meta { font-size: 12px; color: #666; font-family: monospace; margin-top: auto; }

        /* --- ESTILOS ESPECÍFICOS DIAGRAMA 1: ARQUITECTURA SW --- */
        .layer-container {
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        .layer-label {
            position: absolute;
            top: -12px;
            left: 20px;
            background-color: var(--bg-main);
            padding: 0 10px;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .box-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .node-box {
            background-color: var(--box-bg);
            border: 1px solid var(--border);
            padding: 15px;
            text-align: center;
            font-size: 13px;
            cursor: pointer;
        }
        
        .node-box:hover { border-color: var(--text-main); background-color: var(--box-hover); }
        .node-box.full-width { grid-column: span 2; }

        .arrow-down {
            text-align: center;
            color: var(--text-secondary);
            font-size: 20px;
            margin: 5px 0;
        }

        /* --- ESTILOS ESPECÍFICOS DIAGRAMA 2: SECUENCIA DE ARRANQUE --- */
        .timeline-vertical {
            position: relative;
            margin-left: 20px;
            border-left: 2px solid var(--border);
        }

        .timeline-event {
            position: relative;
            margin-bottom: 30px;
            padding-left: 30px;
        }

        .timeline-dot {
            position: absolute;
            left: -7px;
            top: 0;
            width: 12px;
            height: 12px;
            background-color: var(--bg-main);
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
        }

        .timeline-event:hover .timeline-dot { border-color: var(--text-main); background-color: var(--text-main); }

        .timeline-card {
            background-color: var(--box-bg);
            border: 1px solid var(--border);
            padding: 15px;
            cursor: pointer;
        }
        
        .timeline-card:hover { border-color: var(--text-main); }
        .time-label { color: var(--text-secondary); font-size: 11px; margin-bottom: 5px; font-weight: bold;}

        /* --- ESTILOS ESPECÍFICOS DIAGRAMA 3: WATCHDOG LOOP --- */
        .wd-flow {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .wd-node {
            width: 250px;
            background-color: var(--box-bg);
            border: 1px solid var(--border);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .wd-node:hover { border-color: var(--text-main); }

        .diamond {
            width: 80px;
            height: 80px;
            background-color: var(--bg-panel);
            border: 1px solid var(--border);
            transform: rotate(45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            cursor: pointer;
        }

        .diamond-inner { transform: rotate(-45deg); font-size: 11px; text-align: center; }
        .diamond:hover { border-color: var(--text-main); }

        .wd-line { width: 1px; height: 15px; background-color: var(--border); }
        
        .critical-state {
            border-color: #fff;
            border-style: dashed;
            background-color: #222;
        }

    </style>
</head>
<body>

    <header>
        <div>
            <h1>ESQUEMAS TÉCNICOS INTERACTIVOS</h1>
            <div class="subtitle">Basado en documentación técnica de Arquitectura BMS</div>
        </div>
        <div style="font-size: 12px; color: #666;">v1.0.0</div>
    </header>

    <div class="layout">
        <!-- NAVEGACIÓN LATERAL -->
        <nav>
            <button class="nav-btn active" onclick="switchTab('tab1', this)">1. Arquitectura SW</button>
            <button class="nav-btn" onclick="switchTab('tab2', this)">2. Secuencia Arranque</button>
            <button class="nav-btn" onclick="switchTab('tab3', this)">3. Lógica Watchdog</button>
        </nav>

        <!-- ÁREA CENTRAL DE DIAGRAMAS -->
        <main class="diagram-canvas">
            
            <!-- ESQUEMA 1: CAPAS DE SOFTWARE -->
            <div id="tab1" class="diagram-wrapper active">
                <div style="text-align: center; margin-bottom: 20px; color: #666;">FLUJO DE DATOS Y JERARQUÍA</div>
                
                <!-- Capa Aplicación -->
                <div class="layer-container">
                    <div class="layer-label">Capa de Aplicación BMS (ASIL D)</div>
                    <div class="box-grid">
                        <div class="node-box" onclick="showInfo('soc')">Estimación SoC / SOH</div>
                        <div class="node-box" onclick="showInfo('safety_mgr')">Safety Manager ASIL D</div>
                        <div class="node-box full-width" onclick="showInfo('gestion_contactores')">Gestión de Contactores</div>
                    </div>
                </div>

                <div class="arrow-down">↓</div>

                <!-- Capa Servicios -->
                <div class="layer-container">
                    <div class="layer-label">Capa de Servicios</div>
                    <div class="box-grid">
                        <div class="node-box" onclick="showInfo('wd_mgr')">Watchdog Manager (Calcula Key)</div>
                        <div class="node-box" onclick="showInfo('sbc_handler')">SBC Handler (Power Mgmt)</div>
                    </div>
                </div>

                <div class="arrow-down">↓</div>

                <!-- Capa Drivers -->
                <div class="layer-container">
                    <div class="layer-label">Drivers MCAL (Bajo Nivel)</div>
                    <div class="box-grid">
                        <div class="node-box" onclick="showInfo('spi_driver')">SPI Driver (CSIH)</div>
                        <div class="node-box" onclick="showInfo('mcu_driver')">MCU Driver (Escribe Registros)</div>
                    </div>
                </div>

                <div class="arrow-down">↓</div>

                <!-- Hardware Físico -->
                <div class="layer-container" style="background: #111;">
                    <div class="layer-label">Hardware Físico</div>
                    <div class="box-grid">
                        <div class="node-box full-width" style="border-style: dashed;" onclick="showInfo('hw_fisico')">
                            SPI Unit (RH850) ↔ NXP FS26 Logic
                        </div>
                    </div>
                </div>
            </div>

            <!-- ESQUEMA 2: SECUENCIA DE ARRANQUE -->
            <div id="tab2" class="diagram-wrapper">
                <div style="text-align: center; margin-bottom: 20px; color: #666;">LÍNEA DE TIEMPO DE INICIALIZACIÓN</div>
                
                <div class="timeline-vertical">
                    <!-- T0 -->
                    <div class="timeline-event">
                        <div class="timeline-dot"></div>
                        <div class="timeline-card" onclick="showInfo('t0')">
                            <div class="time-label">T0: CONEXIÓN FÍSICA</div>
                            <strong>Batería 12V (KL30) Conectada</strong>
                            <div style="font-size: 12px; color: #888; margin-top: 5px;">PMIC Start-up & BIST</div>
                        </div>
                    </div>

                    <!-- T1 -->
                    <div class="timeline-event">
                        <div class="timeline-dot"></div>
                        <div class="timeline-card" onclick="showInfo('t1')">
                            <div class="time-label">T1: POWER GOOD</div>
                            <strong>Habilita Reguladores (1.1V / 3.3V)</strong>
                            <div style="font-size: 12px; color: #888; margin-top: 5px;">Liberación de Reset (High)</div>
                        </div>
                    </div>

                    <!-- T2 -->
                    <div class="timeline-event">
                        <div class="timeline-dot"></div>
                        <div class="timeline-card" onclick="showInfo('t2')">
                            <div class="time-label">T2: MCU BOOT</div>
                            <strong>Start-up Code RH850</strong>
                            <div style="font-size: 12px; color: #888; margin-top: 5px;">Configuración de PLL a 400MHz</div>
                        </div>
                    </div>

                    <!-- T3 -->
                    <div class="timeline-event">
                        <div class="timeline-dot"></div>
                        <div class="timeline-card" onclick="showInfo('t3')">
                            <div class="time-label">T3: VENTANA 'INIT FS' (256ms)</div>
                            <strong>Configuración Crítica SPI</strong>
                            <div style="font-size: 12px; color: #888; margin-top: 5px;">• Configurar Watchdog Window/Seed<br>• Limpiar Flags de Error</div>
                        </div>
                    </div>

                    <!-- T5 -->
                    <div class="timeline-event">
                        <div class="timeline-dot"></div>
                        <div class="timeline-card" onclick="showInfo('t5')">
                            <div class="time-label">T5: RUN MODE</div>
                            <strong>Operación Cíclica</strong>
                            <div style="font-size: 12px; color: #888; margin-top: 5px;">Loop Infinito: Refresco cada 10ms</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ESQUEMA 3: WATCHDOG -->
            <div id="tab3" class="diagram-wrapper">
                <div style="text-align: center; margin-bottom: 20px; color: #666;">LÓGICA CHALLENGE-RESPONSE</div>

                <div class="wd-flow">
                    <div class="wd-node" onclick="showInfo('challenger')">
                        <strong>NXP FS26 (Challenger)</strong><br>
                        <span style="font-size: 11px; color: #888;">Envía Semilla (Seed) ej. 0xA5</span>
                    </div>

                    <div class="wd-line"></div>
                    <div class="arrow-down" style="font-size: 14px;">↓</div>

                    <div class="wd-node" onclick="showInfo('responder')">
                        <strong>RH850 (Responder)</strong><br>
                        <span style="font-size: 11px; color: #888;">Calcula Key = f(Seed) (LFSR)</span>
                    </div>

                    <div class="wd-line"></div>

                    <div class="wd-node" onclick="showInfo('window_open')">
                        <strong>Ventana Abierta</strong><br>
                        <span style="font-size: 11px; color: #888;">Envía Key (ej. 0x3C)</span>
                    </div>

                    <div class="wd-line"></div>

                    <!-- Decisión -->
                    <div class="diamond" onclick="showInfo('decision_wd')">
                        <div class="diamond-inner">¿Key OK<br>& Tiempo?</div>
                    </div>

                    <div style="display: flex; width: 100%; justify-content: space-between; margin-top: -45px; pointer-events: none;">
                        <span style="margin-left: 20px; font-size: 11px;">NO</span>
                        <span style="margin-right: 20px; font-size: 11px;">SI</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; width: 100%;">
                        <!-- Rama Fallo -->
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="wd-line"></div>
                            <div class="wd-node critical-state" onclick="showInfo('wd_fail')">
                                <strong>FALLO</strong><br>
                                <span style="font-size: 11px; color: #aaa;">Contador++ -> Reset -> Safe State</span>
                            </div>
                        </div>

                        <!-- Rama Éxito -->
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="wd-line"></div>
                            <div class="wd-node" onclick="showInfo('wd_ok')">
                                <strong>ÉXITO</strong><br>
                                <span style="font-size: 11px; color: #888;">Reiniciar Timer -> Nueva Seed</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- PANEL DE DETALLES -->
        <aside>
            <h2 id="detail-title" class="info-title">Selecciona un elemento</h2>
            <p id="detail-desc" class="info-desc">Haz clic en cualquier bloque de los diagramas para ver la información técnica detallada extraída de los esquemas del PDF.</p>
            <div id="detail-meta" class="info-meta">Esperando interacción...</div>
        </aside>
    </div>

    <script>
        // BASE DE DATOS DE INFORMACIÓN (Extraída de los esquemas)
        const db = {
            // Esquema 1
            soc: {
                title: "Estimación SoC / SOH",
                desc: "Algoritmos matemáticos que determinan el Estado de Carga (State of Charge) y el Estado de Salud (State of Health) de la batería. Reside en la capa de aplicación.",
                meta: "Capa: Aplicación"
            },
            safety_mgr: {
                title: "Safety Manager ASIL D",
                desc: "Módulo crítico de seguridad. Gestiona las decisiones de alto nivel para mantener el sistema dentro de los parámetros de seguridad ISO 26262.",
                meta: "Capa: Aplicación | Nivel: ASIL D"
            },
            gestion_contactores: {
                title: "Gestión de Contactores",
                desc: "Lógica para cerrar o abrir los relevadores de alta tensión. Depende del estado de seguridad validado por el Safety Manager.",
                meta: "Control de Potencia"
            },
            wd_mgr: {
                title: "Watchdog Manager",
                desc: "Solicita el estado al PMIC y calcula la llave de respuesta (Key Calculation). Es el intermediario entre la lógica de seguridad y el hardware.",
                meta: "Capa: Servicios"
            },
            sbc_handler: {
                title: "SBC Handler",
                desc: "Manejador del System Basis Chip. Prepara la trama SPI para comunicar las instrucciones de gestión de energía.",
                meta: "Protocolo: SPI"
            },
            spi_driver: {
                title: "SPI Driver (CSIH)",
                desc: "Driver de bajo nivel (MCAL). Se encarga de la serialización de datos y el control del bus CSIH (Clocked Serial Interface High-speed).",
                meta: "MCAL: Microcontroller Abstraction Layer"
            },
            mcu_driver: {
                title: "MCU Driver",
                desc: "Escribe directamente en los registros del microcontrolador para activar periféricos o cambiar estados de pines (DIO Port).",
                meta: "Acceso a Registros"
            },
            hw_fisico: {
                title: "Interconexión Física",
                desc: "Conexión eléctrica entre la unidad SPI del Renesas RH850 y la lógica digital del NXP FS26. Incluye líneas MISO, MOSI, CLK y CS.",
                meta: "Hardware"
            },

            // Esquema 2
            t0: {
                title: "T0: Conexión y BIST",
                desc: "Se aplica voltaje de batería (Vsup > 6V). El PMIC NXP FS26 inicia y ejecuta su autodiagnóstico interno (BIST - Built In Self Test) antes de alimentar al resto.",
                meta: "Evento: Power On"
            },
            t1: {
                title: "T1: Estabilización (Power Good)",
                desc: "El PMIC habilita los reguladores (Soft Start). Una vez que los voltajes de 1.1V y 3.3V son estables, pone el pin RESET_B en estado ALTO (High) para liberar al MCU.",
                meta: "Señales: 1.1V, 3.3V, RESET_B"
            },
            t2: {
                title: "T2: Arranque del MCU",
                desc: "El Renesas RH850 comienza a ejecutar su código de inicio (Startup Code). Configura su reloj interno (PLL) para operar a 400MHz.",
                meta: "Dispositivo: Renesas RH850"
            },
            t3: {
                title: "T3: Ventana Crítica INIT",
                desc: "Ventana de tiempo de aprox. 256ms. El MCU debe escribir vía SPI la configuración del Watchdog (Semilla, Ventana) y limpiar flags de error previos. Si falla aquí, el sistema se reinicia.",
                meta: "Duración: ~256ms"
            },
            t5: {
                title: "T5: Run Mode",
                desc: "El sistema entra en operación normal. Se ejecuta el bucle infinito donde el Watchdog se refresca cada 10ms mediante el esquema Challenge-Response.",
                meta: "Ciclo: 10ms"
            },

            // Esquema 3
            challenger: {
                title: "Challenger (NXP FS26)",
                desc: "El PMIC genera un número aleatorio llamado 'Semilla' (Seed, ej. 0xA5) y lo envía al microcontrolador para desafiar su funcionamiento.",
                meta: "Rol: Maestro de Seguridad"
            },
            responder: {
                title: "Responder (RH850)",
                desc: "El MCU recibe la semilla y ejecuta un algoritmo LFSR (Linear Feedback Shift Register) seguro para calcular una 'Llave' (Key).",
                meta: "Algoritmo: LFSR"
            },
            window_open: {
                title: "Ventana Abierta",
                desc: "El MCU solo puede enviar la respuesta (Key) durante un tiempo específico (Ventana Abierta). Si la envía muy rápido o muy lento, se considera fallo.",
                meta: "Timing Crítico"
            },
            decision_wd: {
                title: "Verificación de Integridad",
                desc: "¿La llave es matemáticamente correcta Y llegó dentro de la ventana de tiempo permitida?",
                meta: "Condición Lógica"
            },
            wd_fail: {
                title: "Fallo de Watchdog",
                desc: "Si la llave es incorrecta o está fuera de tiempo, se incrementa el contador de fallos. Si supera el límite, el PMIC pone RESET en bajo y abre los contactores (FSOB Low -> Safe State).",
                meta: "Acción: SAFE STATE"
            },
            wd_ok: {
                title: "Ciclo Exitoso",
                desc: "El timer del Watchdog se reinicia. El PMIC genera una nueva semilla para el siguiente ciclo de 10ms.",
                meta: "Estado: OK"
            }
        };

        // LÓGICA DE INTERACCIÓN
        function switchTab(tabId, btn) {
            // Ocultar todos los diagramas
            document.querySelectorAll('.diagram-wrapper').forEach(d => d.classList.remove('active'));
            // Mostrar el seleccionado
            document.getElementById(tabId).classList.add('active');
            
            // Gestionar botones
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Resetear panel info
            resetInfo();
        }

        function showInfo(key) {
            const data = db[key];
            if(data) {
                document.getElementById('detail-title').innerText = data.title;
                document.getElementById('detail-desc').innerText = data.desc;
                document.getElementById('detail-meta').innerText = data.meta;
                
                // Highlight visual effect (simple opacity change on others could be added here)
            }
        }

        function resetInfo() {
            document.getElementById('detail-title').innerText = "Selecciona un elemento";
            document.getElementById('detail-desc').innerText = "Navega por el esquema interactivo para ver los detalles técnicos de cada componente.";
            document.getElementById('detail-meta').innerText = "Esperando...";
        }
    </script>
</body>
</html>